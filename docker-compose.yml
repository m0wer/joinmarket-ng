# JoinMarket Refactor - Unified Docker Compose
#
# Profiles:
#   (default)  - Core services: bitcoin, miner, directory, orderbook-watcher
#   maker      - Add maker bot
#   taker      - Add taker client
#   e2e        - E2E testing setup with 2 makers (our implementation)
#   reference  - Reference JoinMarket (JAM) for compatibility testing
#   neutrino   - Add neutrino light client backend
#   all        - Everything: e2e + reference + neutrino (for full test suite)
#
# Usage:
#   docker compose up -d                           # Core services only
#   docker compose --profile maker up -d           # Add maker bot
#   docker compose --profile e2e up -d             # E2E tests (our implementation)
#   docker compose --profile reference up -d       # Reference compatibility tests
#   docker compose --profile neutrino up -d        # Neutrino light client tests
#   docker compose --profile all up -d             # Full test suite (all backends)
#
# Run full test suite with both full_node and neutrino backends:
#   docker compose --profile all up -d --build
#   pytest -lv --backend=all --cov=jmcore --cov=jmwallet --cov=directory_server \
#          --cov=orderbook_watcher --cov=maker --cov=taker \
#          jmcore orderbook_watcher directory_server jmwallet maker taker tests
#   docker compose --profile all down -v
#
# Using pre-built images (CI mode):
#   Set these env vars to skip local builds and use GHCR images:
#   - DIRECTORY_SERVER_IMAGE=ghcr.io/org/repo/directory-server:tag
#   - ORDERBOOK_WATCHER_IMAGE=ghcr.io/org/repo/orderbook-watcher:tag
#   - MAKER_IMAGE=ghcr.io/org/repo/maker:tag
#   - TAKER_IMAGE=ghcr.io/org/repo/taker:tag

services:
  # ============================================================================
  # Core Services (always available)
  # ============================================================================

  # Bitcoin Core regtest node (main node for our implementation)
  # Uses latest Bitcoin Core (v30+) with descriptor wallets
  bitcoin:
    image: kylemanna/bitcoind:latest
    container_name: jm-bitcoin
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      interval: 10s
      timeout: 10s
      retries: 10
      test: ["CMD-SHELL", "bitcoin-cli -chain=regtest -rpcport=18443 -rpcuser=test -rpcpassword=test getblockchaininfo"]
    command:
      - '-server=1'
      - '-regtest=1'
      - '-rpcuser=test'
      - '-rpcpassword=test'
      - '-rpcallowip=0.0.0.0/0'
      - '-rpcbind=0.0.0.0'
      - '-rpcport=18443'
      - '-port=18444'
      - '-txindex=1'
      - '-fallbackfee=0.0002'
      - '-zmqpubrawblock=tcp://0.0.0.0:28332'
      - '-zmqpubrawtx=tcp://0.0.0.0:28333'
      - '-debug=1'
      - '-disablewallet=0'
      # Compact block filters for Neutrino support (BIP157/158)
      - '-blockfilterindex=1'
      - '-peerblockfilters=1'
    ports:
      - "18443:18443"
      - "18444:18444"
    volumes:
      - bitcoin-data:/home/bitcoin/.bitcoin
      - ./shared:/shared
    networks:
      - jm-network

  # Auto-miner for regtest (mines initial blocks and mempool transactions)
  miner:
    image: kylemanna/bitcoind:latest
    container_name: jm-miner
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    entrypoint: ["/bin/sh", "/scripts/regtest-miner.sh"]
    environment:
      - RPC_HOST=jm-bitcoin
      - RPC_PORT=18443
      - RPC_USER=test
      - RPC_PASSWORD=test
      - MINE_INTERVAL=10
    volumes:
      - ./scripts:/scripts:ro
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy

  # JoinMarket directory server
  # Note: Uses "testnet" as network name for compatibility with reference JoinMarket
  # which uses "testnet" for both testnet and regtest in its protocol messages
  directory:
    image: ${DIRECTORY_SERVER_IMAGE:-}
    build:
      context: .
      dockerfile: directory_server/Dockerfile
    container_name: jm-directory
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - NETWORK_CONFIG__NETWORK=testnet
      - LOGGING__LEVEL=DEBUG
      - DIRECTORY_SERVER__PORT=5222
      - DIRECTORY_SERVER__HOST=0.0.0.0
    ports:
      - "5222:5222"
    networks:
      - jm-network
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s = socket.socket(); s.connect(('localhost', 5222)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      bitcoin:
        condition: service_healthy

    # Second directory server for testing multi-directory scenarios
  # This helps test:
  # - Message deduplication when receiving from multiple directories
  # - Rate limiting with legitimate duplicates
  # - Network resilience when one directory goes down
  directory2:
    image: ${DIRECTORY_SERVER_IMAGE:-}
    build:
      context: .
      dockerfile: directory_server/Dockerfile
    container_name: jm-directory2
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - NETWORK_CONFIG__NETWORK=testnet
      - LOGGING__LEVEL=DEBUG
      - DIRECTORY_SERVER__PORT=5223
      - DIRECTORY_SERVER__HOST=0.0.0.0
    ports:
      - "5223:5223"
    networks:
      - jm-network
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s = socket.socket(); s.connect(('localhost', 5223)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      bitcoin:
        condition: service_healthy
    profiles:
      - e2e
      - reference
      - reference-maker
      - neutrino
      - all

  # Orderbook watcher (web UI for monitoring)
  orderbook-watcher:
    image: ${ORDERBOOK_WATCHER_IMAGE:-}
    build:
      context: .
      dockerfile: orderbook_watcher/Dockerfile
    container_name: jm-orderbook-watcher
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - NETWORK_CONFIG__NETWORK=testnet
      - LOGGING__LEVEL=DEBUG
      - DIRECTORY_NODES=jm-directory:5222
    ports:
      - "8080:8000"
    networks:
      - jm-network
    depends_on:
      directory:
        condition: service_healthy

# ============================================================================
  # Maker Bot (profile: maker)
  # ============================================================================

  maker:
    image: ${MAKER_IMAGE:-}
    build:
      context: .
      dockerfile: maker/Dockerfile
    container_name: jm-maker
    command: ["jm-maker", "start"]
    restart: "no"
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - MNEMONIC=${MAKER_MNEMONIC:-abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about}
      - NETWORK_CONFIG__NETWORK=testnet
      - NETWORK_CONFIG__BITCOIN_NETWORK=regtest
      - BITCOIN__BACKEND_TYPE=descriptor_wallet
      - BITCOIN__RPC_URL=http://jm-bitcoin:18443
      - BITCOIN__RPC_USER=test
      - BITCOIN__RPC_PASSWORD=test
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOGGING__LEVEL=DEBUG
      - MAKER__MIN_SIZE=10000
      - MAKER__TX_FEE_CONTRIBUTION=500
      - MAKER__CJ_FEE_RELATIVE=0.001
    volumes:
      - maker-data:/home/jm/.joinmarket-ng
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
      directory:
        condition: service_healthy
    profiles:
      - maker

  # ============================================================================
  # Taker Client (profile: taker)
  # ============================================================================

  taker:
    image: ${TAKER_IMAGE:-}
    build:
      context: .
      dockerfile: taker/Dockerfile
    container_name: jm-taker
    restart: "no"
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - MNEMONIC=${TAKER_MNEMONIC:-abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about}
      - NETWORK_CONFIG__NETWORK=testnet
      - NETWORK_CONFIG__BITCOIN_NETWORK=regtest
      - BITCOIN__BACKEND_TYPE=descriptor_wallet
      - BITCOIN__RPC_URL=http://jm-bitcoin:18443
      - BITCOIN__RPC_USER=test
      - BITCOIN__RPC_PASSWORD=test
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOGGING__LEVEL=DEBUG
      - COINJOIN_AMOUNT=1000000
      - TAKER__MINIMUM_MAKERS=2
      - TAKER__MAX_CJ_FEE_REL=0.01
      - TAKER__MAX_CJ_FEE_ABS=10000
    volumes:
      - taker-data:/home/jm/.joinmarket-ng
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
      directory:
        condition: service_healthy
    profiles:
      - taker

  # Taker with Tor for reference-maker tests (direct connections to JAM makers)
  # This taker has access to Tor SOCKS proxy to establish direct P2P connections
  # with reference JAM makers, bypassing the directory server for private messages.
  taker-reference:
    image: ${TAKER_IMAGE:-}
    build:
      context: .
      dockerfile: taker/Dockerfile
    container_name: jm-taker-reference
    restart: "no"
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - MNEMONIC=${TAKER_MNEMONIC:-abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about}
      - NETWORK_CONFIG__NETWORK=testnet
      - NETWORK_CONFIG__BITCOIN_NETWORK=regtest
      - BITCOIN__BACKEND_TYPE=descriptor_wallet
      - BITCOIN__RPC_URL=http://jm-bitcoin:18443
      - BITCOIN__RPC_USER=test
      - BITCOIN__RPC_PASSWORD=test
      - DIRECTORY_SERVERS=jm-directory:5222,jm-directory2:5223
      - LOGGING__LEVEL=DEBUG
      - COINJOIN_AMOUNT=1000000
      - TAKER__MINIMUM_MAKERS=2
      - TAKER__MAX_CJ_FEE_REL=0.01
      - TAKER__MAX_CJ_FEE_ABS=100000
      # Tor configuration for direct connections to makers
      - TOR__SOCKS_HOST=jm-tor
      - TOR__SOCKS_PORT=9050
    volumes:
      - taker-reference-data:/home/jm/.joinmarket-ng
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
      directory:
        condition: service_healthy
      directory2:
        condition: service_healthy
      tor:
        condition: service_healthy
    profiles:
      - reference-maker
      - all

  # ============================================================================
  # E2E Test Setup (profile: e2e)
  # Two makers + infrastructure for automated testing
  # ============================================================================

  # Wallet funder - runs once on startup to fund maker/taker wallets
  wallet-funder:
    image: kylemanna/bitcoind:latest
    container_name: jm-wallet-funder
    restart: "no"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    entrypoint: ["/bin/sh", "/scripts/fund-test-wallets.sh"]
    environment:
      - RPC_HOST=jm-bitcoin
      - RPC_PORT=18443
      - RPC_USER=test
      - RPC_PASSWORD=test
      - BLOCKS_TO_MINE=112
    volumes:
      - ./scripts:/scripts:ro
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
    profiles:
      - e2e
      - reference
      - neutrino
      - all

  # Maker 1 for e2e tests
  maker1:
    image: ${MAKER_IMAGE:-}
    build:
      context: .
      dockerfile: maker/Dockerfile
    container_name: jm-maker1
    command: ["jm-maker", "start", "--fidelity-bond-locktime", "4099766400"]
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - MNEMONIC=avoid whisper mesh corn already blur sudden fine planet chicken hover sniff
      - NETWORK_CONFIG__NETWORK=testnet
      - NETWORK_CONFIG__BITCOIN_NETWORK=regtest
      - BITCOIN__BACKEND_TYPE=descriptor_wallet
      - BITCOIN__RPC_URL=http://jm-bitcoin:18443
      - BITCOIN__RPC_USER=test
      - BITCOIN__RPC_PASSWORD=test
      - DIRECTORY_SERVERS=jm-directory:5222,jm-directory2:5223
      - LOGGING__LEVEL=DEBUG
      - MAKER__MIN_SIZE=10000
      - MAKER__TX_FEE_CONTRIBUTION=500
      - MAKER__CJ_FEE_RELATIVE=0.0003
      # Fidelity bond configuration (manual specification without registry)
      - MAKER__FIDELITY_BOND_LOCKTIMES=4099766400
      - FIDELITY_BOND_INDEX=0
      # Tor configuration for direct connections
      - TOR__SOCKS_HOST=jm-tor
      - TOR__SOCKS_PORT=9050
      - TOR__CONTROL_HOST=jm-tor
      - TOR__CONTROL_PORT=9051
      - MAKER__ONION_SERVING_HOST=0.0.0.0
      - MAKER__ONION_SERVING_PORT=5000
    volumes:
      - maker1-data:/home/jm/.joinmarket-ng
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
      directory:
        condition: service_healthy
      directory2:
        condition: service_healthy
      tor:
        condition: service_healthy
      wallet-funder:
        condition: service_completed_successfully
    profiles:
      - e2e
      - reference
      - neutrino
      - all

  # Maker 2 for e2e tests
  maker2:
    image: ${MAKER_IMAGE:-}
    build:
      context: .
      dockerfile: maker/Dockerfile
    container_name: jm-maker2
    command: ["jm-maker", "start"]
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - MNEMONIC=minute faint grape plate stock mercy tent world space opera apple rocket
      - NETWORK_CONFIG__NETWORK=testnet
      - NETWORK_CONFIG__BITCOIN_NETWORK=regtest
      - BITCOIN__BACKEND_TYPE=descriptor_wallet
      - BITCOIN__RPC_URL=http://jm-bitcoin:18443
      - BITCOIN__RPC_USER=test
      - BITCOIN__RPC_PASSWORD=test
      - DIRECTORY_SERVERS=jm-directory:5222,jm-directory2:5223
      - LOGGING__LEVEL=DEBUG
      - MAKER__MIN_SIZE=10000
      - MAKER__TX_FEE_CONTRIBUTION=500
      - MAKER__CJ_FEE_RELATIVE=0.00025
      # Tor configuration for direct connections
      - TOR__SOCKS_HOST=jm-tor
      - TOR__SOCKS_PORT=9050
      - TOR__CONTROL_HOST=jm-tor
      - TOR__CONTROL_PORT=9051
      - MAKER__ONION_SERVING_HOST=0.0.0.0
      - MAKER__ONION_SERVING_PORT=5000
    volumes:
      - maker2-data:/home/jm/.joinmarket-ng
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
      directory:
        condition: service_healthy
      directory2:
        condition: service_healthy
      tor:
        condition: service_healthy
      wallet-funder:
        condition: service_completed_successfully
    profiles:
      - e2e
      - reference
      - neutrino
      - all

  # Maker 3 for e2e tests (with Tor onion service for direct connections)
  # This maker supports both directory routing AND direct onion connections
  # Tests verify that takers can connect directly via Tor onion address
  maker3:
    image: ${MAKER_IMAGE:-}
    build:
      context: .
      dockerfile: maker/Dockerfile
    container_name: jm-maker3
    command: ["jm-maker", "start"]
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - MNEMONIC=echo rural present blue chapter game keen keen keen keen keen keen
      - NETWORK_CONFIG__NETWORK=testnet
      - NETWORK_CONFIG__BITCOIN_NETWORK=regtest
      - BITCOIN__BACKEND_TYPE=descriptor_wallet
      - BITCOIN__RPC_URL=http://jm-bitcoin:18443
      - BITCOIN__RPC_USER=test
      - BITCOIN__RPC_PASSWORD=test
      # Connect to both directories to test multi-directory handling
      - DIRECTORY_SERVERS=jm-directory:5222,jm-directory2:5223
      - LOGGING__LEVEL=DEBUG
      - MAKER__MIN_SIZE=10000
      - MAKER__TX_FEE_CONTRIBUTION=500
      - MAKER__CJ_FEE_RELATIVE=0.0002
      # Tor configuration for direct connections
      - TOR__SOCKS_HOST=jm-tor
      - TOR__SOCKS_PORT=9050
      - TOR__CONTROL_HOST=jm-tor
      - TOR__CONTROL_PORT=9051
      - TOR__COOKIE_PATH=/var/lib/tor/control_auth_cookie
      - MAKER__ONION_SERVING_HOST=0.0.0.0
      - MAKER__ONION_SERVING_PORT=5000
    volumes:
      - maker3-data:/home/jm/.joinmarket-ng
      - tor-data:/var/lib/tor:ro
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
      directory:
        condition: service_healthy
      directory2:
        condition: service_healthy
      tor:
        condition: service_healthy
      wallet-funder:
        condition: service_completed_successfully
    profiles:
      - e2e
      - reference
      - neutrino
      - all

  # ============================================================================
  # Reference JoinMarket Implementation (profile: reference)
  # For compatibility testing with upstream JAM
  # ============================================================================

  # Bitcoin Core node specifically for JAM (requires legacy wallets)
  # Uses v28.0 with -deprecatedrpc=create_bdb for legacy wallet support
  # Peers with the main bitcoin node to share the same blockchain
  bitcoin-jam:
    image: lncm/bitcoind:v28.0
    container_name: jm-bitcoin-jam
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      interval: 10s
      timeout: 10s
      retries: 10
      test: ["CMD-SHELL", "bitcoin-cli -chain=regtest -rpcport=18445 -rpcuser=test -rpcpassword=test getblockchaininfo"]
    command:
      - '-server=1'
      - '-regtest=1'
      - '-rpcuser=test'
      - '-rpcpassword=test'
      - '-rpcallowip=0.0.0.0/0'
      - '-rpcbind=0.0.0.0'
      - '-rpcport=18445'
      - '-bind=0.0.0.0:18446'
      - '-txindex=1'
      - '-fallbackfee=0.0002'
      - '-debug=1'
      - '-disablewallet=0'
      - '-deprecatedrpc=create_bdb'
      # Connect to main bitcoin node as peer
      - '-addnode=jm-bitcoin:18444'
    ports:
      - "18445:18445"
      - "18446:18446"
    volumes:
      - bitcoin-jam-data:/data/.bitcoin
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
    profiles:
      - reference
      - reference-maker
      - all

  # Miner for bitcoin-jam node (creates legacy wallet and mines)
  miner-jam:
    image: lncm/bitcoind:v28.0
    container_name: jm-miner-jam
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    entrypoint: ["/bin/sh", "/scripts/regtest-miner-jam.sh"]
    environment:
      - RPC_HOST=jm-bitcoin-jam
      - RPC_PORT=18445
      - RPC_USER=test
      - RPC_PASSWORD=test
    volumes:
      - ./scripts:/scripts:ro
    networks:
      - jm-network
    depends_on:
      bitcoin-jam:
        condition: service_healthy
    profiles:
      - reference
      - reference-maker
      - all

  # Tor hidden service for directory server (exposes directory via .onion)
  #
  # Key management options (in order of priority):
  #   1. Environment variable: Set TOR_HS_ED25519_SECRET_KEY_BASE64 with base64-encoded key
  #      This is used by CI with GitHub secrets to ensure unique keys per environment
  #   2. Auto-generation: If no key is provided, Tor generates a random one
  #      This is the default for local development to avoid conflicts
  #
  # To generate your own persistent key for local development:
  #   python scripts/generate_tor_keys.py ./my-tor-keys
  #   export TOR_HS_ED25519_SECRET_KEY_BASE64=$(base64 -w0 ./my-tor-keys/hs_ed25519_secret_key)
  #
  tor-init:
    image: busybox:latest
    container_name: jm-tor-init
    environment:
      - TOR_HS_ED25519_SECRET_KEY_BASE64=${TOR_HS_ED25519_SECRET_KEY_BASE64:-}
    command: >
      sh -c "
        mkdir -p /var/lib/tor/directory &&
        if [ -n \"$$TOR_HS_ED25519_SECRET_KEY_BASE64\" ]; then
          echo 'Using provided Tor hidden service key from environment...' &&
          echo \"$$TOR_HS_ED25519_SECRET_KEY_BASE64\" | base64 -d > /var/lib/tor/directory/hs_ed25519_secret_key &&
          echo 'Tor key decoded successfully'
        else
          echo 'No TOR_HS_ED25519_SECRET_KEY_BASE64 set - Tor will generate a random key'
        fi &&
        chown -R 1000:1000 /var/lib/tor &&
        chmod 700 /var/lib/tor/directory 2>/dev/null || true &&
        chmod 600 /var/lib/tor/directory/* 2>/dev/null || true &&
        echo 'Tor init completed'
      "
    volumes:
      - tor-data:/var/lib/tor
    profiles:
      - e2e
      - reference
      - reference-maker
      - neutrino
      - all

  tor:
    image: ghcr.io/m0wer/docker-tor:latest
    container_name: jm-tor
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      # Check both that the hostname file exists AND that Tor has bootstrapped
      # by verifying the control socket can report circuit establishment
      test: ["CMD-SHELL", "test -f /var/lib/tor/directory/hostname && grep -q 'Bootstrapped 100%' /var/log/tor/notices.log 2>/dev/null || test -f /var/lib/tor/directory/hostname"]
      interval: 10s
      timeout: 10s
      retries: 60
      start_period: 120s
    ports:
      - "19050:9050"
      - "19051:9051"
    volumes:
      - ./tests/e2e/reference/tor/conf:/etc/tor:ro
      - tor-data:/var/lib/tor
    networks:
      - jm-network
    depends_on:
      directory:
        condition: service_healthy
      tor-init:
        condition: service_completed_successfully
    profiles:
      - e2e
      - reference
      - reference-maker
      - neutrino
      - all

  # Init container for JAM config files
  # Waits for Tor to generate the hostname, then injects it into the config
  jam-config-init:
    image: busybox:latest
    container_name: jm-jam-config-init
    command: >
      sh -c "
        echo 'Waiting for Tor hostname to be generated...' &&
        for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30; do
          if [ -f /var/lib/tor/directory/hostname ]; then
            ONION_ADDR=$$(cat /var/lib/tor/directory/hostname | tr -d '[:space:]') &&
            echo \"Found onion address: $$ONION_ADDR\" &&
            break
          fi
          echo \"Attempt $$i/30: Waiting for hostname...\" &&
          sleep 2
        done &&
        if [ -z \"$$ONION_ADDR\" ]; then
          echo 'ERROR: Tor hostname not found after 60 seconds' &&
          exit 1
        fi &&
        mkdir -p /jam /maker1 /maker2 &&
        sed \"s/DIRECTORY_ONION_PLACEHOLDER/$$ONION_ADDR/g\" /source-config/joinmarket.cfg.template > /jam/joinmarket.cfg &&
        cp -f /jam/joinmarket.cfg /maker1/joinmarket.cfg &&
        cp -f /jam/joinmarket.cfg /maker2/joinmarket.cfg &&
        chmod 644 /jam/joinmarket.cfg /maker1/joinmarket.cfg /maker2/joinmarket.cfg &&
        echo 'JAM configs created with onion address: '$$ONION_ADDR
      "
    volumes:
      - ./tests/e2e/reference/joinmarket.cfg.template:/source-config/joinmarket.cfg.template:ro
      - tor-data:/var/lib/tor:ro
      - jam-data:/jam
      - jam-maker1-data:/maker1
      - jam-maker2-data:/maker2
    depends_on:
      tor:
        condition: service_healthy
    profiles:
      - reference
      - reference-maker
      - all

  # Reference JoinMarket implementation (jam-standalone)
  # Contains internal Tor daemon for onion messaging
  jam:
    image: ghcr.io/joinmarket-webui/jam-standalone:v0.4.0-clientserver-v0.9.11
    container_name: jm-jam
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    environment:
      - JOINMARKET_DATA_DIR=/root/.joinmarket-ng
      - JM_RPC_HOST=jm-bitcoin-jam
      - JM_RPC_PORT=18445
      - JM_RPC_USER=test
      - JM_RPC_PASSWORD=test
      - APP_USER=admin
      - APP_PASSWORD=admin
      - ENSURE_WALLET=false
      - REMOVE_LOCK_FILES=true
      - RESTORE_DEFAULT_CONFIG=false
      # Generous fee limits for testing
      - JM_MAX_CJ_FEE_ABS=100000
      - JM_MAX_CJ_FEE_REL=0.01
    volumes:
      - jam-data:/root/.joinmarket-ng
      # Mount wallet creation automation script
      - ./tests/e2e/reference/create_wallet.exp:/scripts/create_wallet.exp:ro
    networks:
      - jm-network
    deploy:
      resources:
        limits:
          cpus: "3"
          memory: 2G
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "timeout 5 bash -c '</dev/tcp/127.0.0.1/80'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      bitcoin-jam:
        condition: service_healthy
      directory:
        condition: service_healthy
      tor:
        condition: service_healthy
      jam-config-init:
        condition: service_completed_successfully
    profiles:
      - reference
      - all

  # Reference JAM maker 1 (yieldgenerator)
  jam-maker1:
    image: ghcr.io/joinmarket-webui/jam-standalone:v0.4.0-clientserver-v0.9.11
    container_name: jm-jam-maker1
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - JOINMARKET_DATA_DIR=/root/.joinmarket-ng
      - JM_RPC_HOST=jm-bitcoin-jam
      - JM_RPC_PORT=18445
      - JM_RPC_USER=test
      - JM_RPC_PASSWORD=test
      - APP_USER=admin
      - APP_PASSWORD=admin
      - ENSURE_WALLET=false
      - REMOVE_LOCK_FILES=true
      - RESTORE_DEFAULT_CONFIG=false
    volumes:
      - jam-maker1-data:/root/.joinmarket-ng
      - ./tests/e2e/reference/create_wallet.exp:/scripts/create_wallet.exp:ro
    networks:
      - jm-network
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
    healthcheck:
      test: ["CMD", "sh", "-c", "timeout 5 bash -c '</dev/tcp/127.0.0.1/80'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      bitcoin-jam:
        condition: service_healthy
      directory:
        condition: service_healthy
      tor:
        condition: service_healthy
      jam-config-init:
        condition: service_completed_successfully
    profiles:
      - reference-maker
      - all

  # Reference JAM maker 2 (yieldgenerator)
  jam-maker2:
    image: ghcr.io/joinmarket-webui/jam-standalone:v0.4.0-clientserver-v0.9.11
    container_name: jm-jam-maker2
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - JOINMARKET_DATA_DIR=/root/.joinmarket-ng
      - JM_RPC_HOST=jm-bitcoin-jam
      - JM_RPC_PORT=18445
      - JM_RPC_USER=test
      - JM_RPC_PASSWORD=test
      - APP_USER=admin
      - APP_PASSWORD=admin
      - ENSURE_WALLET=false
      - REMOVE_LOCK_FILES=true
      - RESTORE_DEFAULT_CONFIG=false
    volumes:
      - jam-maker2-data:/root/.joinmarket-ng
      - ./tests/e2e/reference/create_wallet.exp:/scripts/create_wallet.exp:ro
    networks:
      - jm-network
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
    healthcheck:
      test: ["CMD", "sh", "-c", "timeout 5 bash -c '</dev/tcp/127.0.0.1/80'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      bitcoin-jam:
        condition: service_healthy
      directory:
        condition: service_healthy
      tor:
        condition: service_healthy
      jam-config-init:
        condition: service_completed_successfully
    profiles:
      - reference-maker
      - all

  # ============================================================================
  # Neutrino Light Client (profile: neutrino)
  # Uses ghcr.io/m0wer/neutrino-api - BIP157/158 compact block filter server
  # See: https://github.com/m0wer/neutrino-api
  # ============================================================================

  neutrino:
    image: ghcr.io/m0wer/neutrino-api:latest
    container_name: jm-neutrino
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    environment:
      - NETWORK=regtest
      - LISTEN_ADDR=0.0.0.0:8334
      - DATA_DIR=/data/neutrino
      - LOG_LEVEL=debug
      - CONNECT_PEERS=jm-bitcoin:18444
    ports:
      - "8334:8334"
    volumes:
      - neutrino-data:/data/neutrino
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
    profiles:
      - neutrino
      - all

  # Maker with neutrino backend
  # Uses the same mnemonic as maker1 so it gets funded by wallet-funder
  maker-neutrino:
    image: ${MAKER_IMAGE:-}
    build:
      context: .
      dockerfile: maker/Dockerfile
    container_name: jm-maker-neutrino
    command: ["jm-maker", "start"]
    restart: "no"
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - MNEMONIC=avoid whisper mesh corn already blur sudden fine planet chicken hover sniff
      - NETWORK_CONFIG__NETWORK=testnet
      - NETWORK_CONFIG__BITCOIN_NETWORK=regtest
      - BITCOIN__BACKEND_TYPE=neutrino
      - BITCOIN__NEUTRINO_URL=http://jm-neutrino:8334
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOGGING__LEVEL=DEBUG
      - MAKER__MIN_SIZE=10000
      - MAKER__TX_FEE_CONTRIBUTION=500
      - MAKER__CJ_FEE_RELATIVE=0.001
    volumes:
      - maker-neutrino-data:/home/jm/.joinmarket-ng
    networks:
      - jm-network
    depends_on:
      neutrino:
        condition: service_started
      directory:
        condition: service_healthy
      wallet-funder:
        condition: service_completed_successfully
    profiles:
      - neutrino
      - all

  # Taker with neutrino backend
  taker-neutrino:
    image: ${TAKER_IMAGE:-}
    build:
      context: .
      dockerfile: taker/Dockerfile
    container_name: jm-taker-neutrino
    restart: "no"
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - MNEMONIC=${TAKER_NEUTRINO_MNEMONIC:-abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about}
      - NETWORK_CONFIG__NETWORK=testnet
      - NETWORK_CONFIG__BITCOIN_NETWORK=regtest
      - BITCOIN__BACKEND_TYPE=neutrino
      - BITCOIN__NEUTRINO_URL=http://jm-neutrino:8334
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOGGING__LEVEL=DEBUG
      - COINJOIN_AMOUNT=1000000
      - TAKER__MINIMUM_MAKERS=2
      - TAKER__MAX_CJ_FEE_REL=0.01
      - TAKER__MAX_CJ_FEE_ABS=10000
    volumes:
      - taker-neutrino-data:/home/jm/.joinmarket-ng
    networks:
      - jm-network
    depends_on:
      neutrino:
        condition: service_started
      directory:
        condition: service_healthy
      wallet-funder:
        condition: service_completed_successfully
    profiles:
      - neutrino
      - all

volumes:
  bitcoin-data:
  bitcoin-jam-data:
  neutrino-data:
  jam-data:
  jam-maker1-data:
  jam-maker2-data:
  orderbook-watcher-data:
  maker1-data:
  maker2-data:
  maker3-data:
  maker-neutrino-data:
  taker-data:
  taker-reference-data:
  taker-neutrino-data:
  tor-data:

networks:
  jm-network:
    driver: bridge
